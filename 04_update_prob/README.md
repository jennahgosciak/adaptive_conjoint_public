# Bayesian updating of context/treatment assignment probabilites:

## Step 1: Data Export
After we have generated new **100** responses to the survey questions from Qualtrics, we load the data locally in R using a function from the `qualtRics` package.

## Step 2: Survey Validation
Ensure all responses are loaded from Qualtrics. Drop any participants from before the time stamp of the study start (i.e., excluding participants in the pilot study). Additionally, we implement the following checks and drop participants who do not meet the following criteria:
* The status is not one of "Survey Preview" or "Survey Test"
* We have received consent from all respondents
* Respondents do not fail the age and location checks for eligibility (i.e., they are over 18 and in the U.S.)

## Step 3: Data Cleaning
* Produce a profile variable that indicates which profile context the respondent saw
* Produce a numeric variable indicating the respondent's preference for the younger variable regardless of the question ordering
* Check the total of all the responses to the different question orderings is always less than or equal to 1
* Check distribution of profiles and compare similarity to the distribution generated by the context assignment probabilities; ensure these are comparable.

## Step 4. Update Probabilities
* Compute the total number of outcomes equal to 1 and the total number of outcomes equal to 0 for each profile context
* For a pre-determined number of iterations (e.g., 1000), produce random draws from a Beta distrbution with updated alpha and beta parameters (prior is alpha = 1 and beta = 1) of the total number of outcomes equal to 1 and 0.
* For each iteration, identify the profile context with the highest draw
* Compute the average across the simulations: this average is the probability that a given profile context will have the highest number of outcomes = 1 (i.e., the "highest performing arm").
* The vector of these averages is the input probability vector for assiging profile contexts to respondents in a new batch of 100 survey responses.

## Step 5: Update Qualtrics Embedded Data Varibles
* First, download the survey flow from Qualtrics using the API.
* With a named vector of new probabilities, produced in step 4, iterate through the embedded data variables that store the probabilities for assigning profile contexts.
* Ensure the assigned name in the probability vector and the embedded variable name match before replacing.
* Send the updated survey flow items to Qualtrics.
